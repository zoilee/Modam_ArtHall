<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/layout/style.css}">
</head>
<body>

<!-- 헤더 -->
<th:block th:replace="~{fragments/header :: headerFragment}"></th:block>
    
<div class="container my-5" style="padding-top: 100px;">
    <h2 class="text-center mb-4">개인정보 수정</h2>
    <form th:action="@{/registeruserEdit}" method="post" id="edit-user-form">
        <!-- 아이디 (수정 불가) -->
        <div class="form-group">
            <label for="userid">아이디</label>
            <input type="text" class="form-control" id="userid" name="userid" th:value="${user.loginId}" readonly
                   style="cursor: not-allowed;" title="아이디는 수정할 수 없습니다.">
        </div>

        <!-- 새로운 비밀번호 -->
        <div class="form-group">
            <label for="new-password">새로운 비밀번호(선택)</label>
            <input type="password" class="form-control" id="new-password" name="newPassword" placeholder="새로운 비밀번호를 입력하세요"
                   minlength="8" maxlength="20" pattern="^[A-Za-z\d]{8,20}$" title="8~20자, 영문 대소문자와 숫자만 가능합니다.">
        </div>

        <!-- 비밀번호 확인 -->
        <div class="form-group">
            <label for="confirm-password">새로운 비밀번호 확인</label>
            <input type="password" class="form-control" id="confirm-password" name="confirmPassword" placeholder="새로운 비밀번호를 다시 입력하세요"
                   minlength="8" maxlength="20" pattern="^[A-Za-z\d]{8,20}$" title="8~20자, 영문 대소문자와 숫자만 가능합니다.">
            <small id="password-match-feedback" class="form-text text-danger" style="display: none;">
                비밀번호가 일치하지 않습니다.
            </small>
        </div>

        <!-- 이름 -->
        <div class="form-group">
            <label for="name">이름(선택)</label>
            <input type="text" class="form-control" id="name" name="name" th:value="${user.name}" required
                   pattern="^[가-힣a-zA-Z]+$" title="이름은 한글, 영어만 가능합니다.">
        </div>

        <!-- 이메일 -->
        <div class="form-group">
            <label for="email">이메일(선택)</label>
            <input type="email" class="form-control" id="email" name="email" th:value="${user.email}" required
                   pattern="^[a-zA-Z0-9._]+@[a-zA-Z0-9.-]+\.[a-z]{2,}$" title="올바른 이메일 형식을 입력하세요. 예: example@domain.com">
            <small class="text-danger" th:text="${emailError}" th:if="${emailError != null}"></small>
        </div>

        <!-- 전화번호 -->
        <div class="form-group">
            <label for="phone">연락처(선택)</label>
            <input type="tel" class="form-control" id="phone" name="phoneNumber" th:value="${user.phoneNumber}" required
                   pattern="^\d{10,11}$" title="전화번호는 숫자 10~11자만 입력 가능합니다.">
            <small class="text-danger" th:text="${phoneError}" th:if="${phoneError != null}"></small>
        </div>

        <!-- 수정 버튼 -->
        <button type="submit" class="btn btn-primary mt-3">수정하기</button>
    </form>
</div>

<!-- Footer -->
<th:block th:replace="~{fragments/footer :: footerFragment}"></th:block>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    // 비밀번호 일치 여부 확인
    document.getElementById('confirm-password').addEventListener('input', function () {
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = this.value;
        const feedback = document.getElementById('password-match-feedback');

        if (newPassword !== confirmPassword) {
            feedback.style.display = 'block';
        } else {
            feedback.style.display = 'none';
        }
    });

    // 이메일 중복 확인
    document.getElementById('email').addEventListener('blur', function () {
        const email = this.value;
        const feedback = document.getElementById('email-feedback');

        fetch(`/user/api/check-email?email=${email}`)
            .then(response => response.json())
            .then(data => {
                if (data.exists) {
                    feedback.textContent = "이미 사용 중인 이메일입니다.";
                    feedback.classList.add('text-danger');
                } else {
                    feedback.textContent = "";
                    feedback.classList.remove('text-danger');
                }
            });
    });

    // 전화번호 중복 확인
    document.getElementById('phone').addEventListener('blur', function () {
        const phone = this.value;
        const feedback = document.getElementById('phone-feedback');

        fetch(`/user/api/check-phone?phone=${phone}`)
            .then(response => response.json())
            .then(data => {
                if (data.exists) {
                    feedback.textContent = "이미 사용 중인 전화번호입니다.";
                    feedback.classList.add('text-danger');
                } else {
                    feedback.textContent = "";
                    feedback.classList.remove('text-danger');
                }
            });
    });
</script>
</script>
</body>
</html>