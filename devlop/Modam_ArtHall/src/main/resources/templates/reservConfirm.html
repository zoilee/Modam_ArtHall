<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>reservConfirm</title>
    <!-- 스타일 시트 -->
    <link rel="stylesheet" th:href="@{/css/layout/style.css}">
    <link rel="stylesheet" th:href="@{/css/reserv/reservConfirm.css}">
    <link rel="stylesheet" th:href="@{/css/admin/style.css}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
</head>
<body>

     <!-- 헤더 -->
     <th:block th:replace="~{fragments/header :: headerFragment}"></th:block>

    <!-- Main Content -->
    <div class="content container my-4" style="padding: 100px 0;">
        
        <!-- 상단 섹션: 예약 내용 확인 -->
        <div class="background-gray mb-4">
            <div class="row">
                <!-- 왼쪽 섹션: 예약내용확인 텍스트와 포스터 -->
                <div class="col-6 d-flex ">
                    <div class="col-md-4 d-flex align-items-center">
                        <h5 class="left-section-title">예약내용확인</h5>
                    </div>
                    <div class="col-md-8 d-flex align-items-center">
                        <div class="poster-box">포스터</div>
                    </div>
                </div>
                <!-- 오른쪽 섹션: 공연 정보 -->
                <div class="col-md-6 ">
                    <div class="mb-3">
                        <label class="form-label">공연제목</label>
                        <input type="text" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">관람일자</label>
                        <input type="text" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">관람시간</label>
                        <input type="text" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">티켓 수</label>
                        <input type="text" class="form-control" readonly>
                    </div>
                </div>
            </div>
        </div>

        <!-- 중간 섹션: 적립금 사용 및 결제 요약 -->
        <div class="row mb-4" style="padding-top: 50px;">
            <!-- 적립금 사용 섹션 -->
            <div class="col-md-6 points-section">
                <label>적립금사용</label>
                <div class="input-group mt-2">
                    <span class="input-group-text">현재 적립금 nnnn원</span>
                    <input type="text" class="form-control" placeholder="원">
                </div>
            </div>

            <!-- 결제 요약 섹션 -->
            <div class="col-md-6">
                <div class="payment-summary">
                    <h5 class="section-title">결제금액</h5>
                    <ul class="list-unstyled">
                        <li class="d-flex justify-content-between"><span>VIP 석 1매</span> <span>200,000 원</span></li>
                        <li class="d-flex justify-content-between"><span>S 석 1매</span> <span>80,000 원</span></li>
                        <li class="d-flex justify-content-between text-danger"><span>적립금사용</span> <span>-5,000 원</span></li>
                    </ul>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold">총 액</span>
                        <span class="total-amount">275,000 원</span>
                    </div>
                    <button class="btn btn-custom mt-3">결제하기</button>
                </div>
            </div>
        </div>
        
    </div>

    <!-- 푸터 가져오기 -->
<th:block th:replace="~{fragments/footer :: footerFragment}"></th:block> 
</body>
<script>
    function generateTicketId() {
        // 현재 날짜 yyyyMMdd 형식으로 변환
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작
        const dd = String(now.getDate()).padStart(2, '0');
        const datePart = `${yyyy}${mm}${dd}`; // yyyyMMdd 형식

        // UUID에서 앞부분 8자리 추출
        const uuidPart = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            const r = (Math.random() * 16) | 0;
            const v = c === 'x' ? r : (r & 0x3) | 0x8;
            return v.toString(16);
        }).substring(0, 8); // 앞에서 8자리만 가져오기

        // 날짜와 UUID 결합
        return `${datePart}-${uuidPart}`;
    }

    console.log(generateTicketId());


    $(document).ready(function () {

        var IMP = window.IMP; 
        IMP.init("imp82757082");

        //결제시작버튼
        $(".btn-custom").click(function () {
            // const merchantUid = generateMerchantUid();


            IMP.request_pay({
                pg: "html5_inicis.",
                pay_method: "card",
                ticket: "ORD20231030-000023",   // 주문번호
                name: "공연 티켓 결제",
                amount: 500,                         
                buyer_email: "test@example.com",
                buyer_name: "홍길동",
                buyer_tel: "010-4242-4242",

            }, function(rep){
                const {status, err_msg} = rep;
                if(err_msg){
                    alert(err_msg);
                }
                if (status === "paid"){
                    $.ajax({
                        url: 'payments/process',
                        type: 'post',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            ticket_uid: rep.ticket_uid,
                            amount: rep.amount,
                            buyer_email: rep.buyer_email,
                            buyer_name: rep.buyer_name,
                            buyer_tel: rep.buyer_tel,
                            status: 'paid',
                            imp_uid: rep.imp_uid
                        }),
                        success: function(response){
                            alert("결제 완료" + JSON.stringify(response));
                            console(response); //백엔드 응답 체크
                        },
                        error: function(xhr, status, error){
                            alert("서버 처리 오류" + xhr.responseText);
                            console.error("결제 에러",error );
                        }

                    });

                }




            })
            
            
           
            
            
            // 결제 데이터 준비
            const paymentData = {
                amount: 500, // 결제 금액
                currency: "KRW", // 통화
                //고유 번호는 서버에서 처리
                name: "공연 티켓 결제", // 결제 제목
                buyer_name: "홍길동", // 구매자 이름
                buyer_email: "test@example.com", // 구매자 이메일
                buyer_tel: "010-1234-5678" // 구매자 전화번호
            };

        })
    });
</script>
</html>
